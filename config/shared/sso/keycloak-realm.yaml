# Keycloak Realm Configuration for Grafana
# Import this into Keycloak or use as reference

realm: grafana

# Client configuration for Grafana
clients:
  - clientId: grafana
    name: Grafana
    description: "Grafana Monitoring Platform"
    enabled: true
    protocol: openid-connect
    publicClient: false
    standardFlowEnabled: true
    directAccessGrantsEnabled: false
    serviceAccountsEnabled: false
    
    # Redirect URIs - add all environment URLs
    redirectUris:
      - "http://localhost:3000/*"           # NPR local
      - "https://grafana-npr.example.com/*"
      - "https://grafana-preprod.example.com/*"
      - "https://grafana.example.com/*"
    
    webOrigins:
      - "http://localhost:3000"
      - "https://grafana-npr.example.com"
      - "https://grafana-preprod.example.com"
      - "https://grafana.example.com"
    
    # Token settings
    attributes:
      access.token.lifespan: 300
      oauth2.device.authorization.grant.enabled: false
      backchannel.logout.session.required: true
      post.logout.redirect.uris: "+"

# Protocol mappers for Grafana
protocolMappers:
  - name: groups
    protocol: openid-connect
    protocolMapper: oidc-group-membership-mapper
    config:
      claim.name: groups
      full.path: false
      id.token.claim: true
      access.token.claim: true
      userinfo.token.claim: true

  - name: org
    protocol: openid-connect
    protocolMapper: oidc-usermodel-attribute-mapper
    config:
      claim.name: org
      user.attribute: grafana_org
      id.token.claim: true
      access.token.claim: true
      userinfo.token.claim: true
      jsonType.label: String

# Groups for Grafana access
groups:
  # Global roles
  - name: grafana-users
    path: /grafana-users
    
  - name: grafana-admin
    path: /grafana-admin
    
  - name: grafana-editor
    path: /grafana-editor

  # Organization-specific groups
  - name: platform-team
    path: /platform-team
    attributes:
      grafana_org: ["Platform Team"]
      
  - name: platform-admins
    path: /platform-admins
    attributes:
      grafana_org: ["Platform Team"]

  - name: app-team
    path: /app-team
    attributes:
      grafana_org: ["Application Team"]
      
  - name: app-admins
    path: /app-admins
    attributes:
      grafana_org: ["Application Team"]

  - name: bi-team
    path: /bi-team
    attributes:
      grafana_org: ["Business Intelligence"]
      
  - name: bi-admins
    path: /bi-admins
    attributes:
      grafana_org: ["Business Intelligence"]

# Default roles for new users
defaultRoles:
  - grafana-users
