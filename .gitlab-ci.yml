# GitLab CI/CD for Grafana as Code
# This pipeline manages Terraform deployments across NPR, PreProd, and Prod environments

stages:
  - validate
  - security
  - plan
  - apply
  - cleanup

variables:
  TF_VERSION: "1.6.0"
  TF_ROOT: ${CI_PROJECT_DIR}
  TF_STATE_NAME: default
  # Vault configuration (set in GitLab CI/CD variables)
  # VAULT_ADDR: "https://vault.example.com"
  # VAULT_TOKEN: (masked variable)

# Default settings
default:
  image:
    name: hashicorp/terraform:${TF_VERSION}
    entrypoint: [""]
  before_script:
    - cd ${TF_ROOT}
    - terraform --version
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${TF_ROOT}/.terraform/

# =============================================================================
# VALIDATE STAGE - Run on all branches
# =============================================================================

fmt:check:
  stage: validate
  script:
    - terraform fmt -check -recursive -diff
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:
  stage: validate
  script:
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

lint:yaml:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install yamllint
  script:
    - yamllint -d relaxed config/
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# SECURITY STAGE - Security scanning
# =============================================================================

tfsec:
  stage: security
  image:
    name: aquasec/tfsec:latest
    entrypoint: [""]
  before_script: []
  script:
    - tfsec . --format json --out tfsec-report.json || true
    - tfsec . --format lovely
  artifacts:
    reports:
      security: tfsec-report.json
    paths:
      - tfsec-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

checkov:
  stage: security
  image:
    name: bridgecrew/checkov:latest
    entrypoint: [""]
  before_script: []
  script:
    - checkov -d . --framework terraform --output cli --output junitxml --output-file-path . || true
  artifacts:
    reports:
      junit: results_junitxml.xml
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# PLAN STAGE - Generate Terraform plans
# =============================================================================

.plan_template: &plan_template
  stage: plan
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Generating plan for ${ENVIRONMENT}..."
      terraform plan \
        -var-file="environments/${ENVIRONMENT}.tfvars" \
        -out="${ENVIRONMENT}.tfplan" \
        -input=false
    - |
      echo "Generating plan summary..."
      terraform show -no-color "${ENVIRONMENT}.tfplan" > "${ENVIRONMENT}-plan.txt"
  artifacts:
    paths:
      - "${ENVIRONMENT}.tfplan"
      - "${ENVIRONMENT}-plan.txt"
    expire_in: 1 day
    reports:
      terraform: "${ENVIRONMENT}-plan.txt"

plan:npr:
  <<: *plan_template
  variables:
    ENVIRONMENT: npr
  environment:
    name: npr
    action: prepare
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

plan:preprod:
  <<: *plan_template
  variables:
    ENVIRONMENT: preprod
  environment:
    name: preprod
    action: prepare
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

plan:prod:
  <<: *plan_template
  variables:
    ENVIRONMENT: prod
  environment:
    name: production
    action: prepare
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# APPLY STAGE - Deploy Terraform changes
# =============================================================================

.apply_template: &apply_template
  stage: apply
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Applying changes to ${ENVIRONMENT}..."
      terraform apply \
        -input=false \
        -auto-approve \
        "${ENVIRONMENT}.tfplan"
    - |
      echo "Deployment Summary:"
      terraform output -json > "${ENVIRONMENT}-outputs.json"
      cat "${ENVIRONMENT}-outputs.json" | jq '.deployment_summary.value'
  artifacts:
    paths:
      - "${ENVIRONMENT}-outputs.json"
    expire_in: 1 week

apply:npr:
  <<: *apply_template
  variables:
    ENVIRONMENT: npr
  environment:
    name: npr
    url: http://localhost:3000
    on_stop: destroy:npr
  needs:
    - job: plan:npr
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success

apply:preprod:
  <<: *apply_template
  variables:
    ENVIRONMENT: preprod
  environment:
    name: preprod
    url: https://grafana-preprod.example.com
  needs:
    - job: plan:preprod
      artifacts: true
    - job: apply:npr
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

apply:prod:
  <<: *apply_template
  variables:
    ENVIRONMENT: prod
  environment:
    name: production
    url: https://grafana.example.com
  needs:
    - job: plan:prod
      artifacts: true
    - job: apply:preprod
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

# =============================================================================
# CLEANUP STAGE - Destroy environments (manual)
# =============================================================================

destroy:npr:
  stage: cleanup
  variables:
    ENVIRONMENT: npr
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Destroying ${ENVIRONMENT} environment..."
      terraform destroy \
        -var-file="environments/${ENVIRONMENT}.tfvars" \
        -auto-approve
  environment:
    name: npr
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# =============================================================================
# SCHEDULED JOBS - Drift detection
# =============================================================================

drift:detection:
  stage: validate
  script:
    - |
      for ENV in npr preprod prod; do
        echo "Checking drift for ${ENV}..."
        terraform init -backend-config="backends/${ENV}.tfbackend" -reconfigure
        terraform plan \
          -var-file="environments/${ENV}.tfvars" \
          -detailed-exitcode \
          -input=false \
          || if [ $? -eq 2 ]; then
            echo "WARNING: DRIFT DETECTED in ${ENV}!"
            exit 1
          fi
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

# =============================================================================
# MERGE REQUEST JOBS - Summary comment
# =============================================================================

mr:plan-summary:
  stage: apply
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "## Terraform Plan Summary" > summary.md
      echo "" >> summary.md
      for ENV in npr preprod prod; do
        if [ -f "${ENV}-plan.txt" ]; then
          echo "### ${ENV^^}" >> summary.md
          echo '```' >> summary.md
          grep -E "Plan:|No changes" "${ENV}-plan.txt" || echo "See full plan" >> summary.md
          echo '```' >> summary.md
          echo "" >> summary.md
        fi
      done
      cat summary.md
  needs:
    - job: plan:npr
      artifacts: true
    - job: plan:preprod
      artifacts: true
    - job: plan:prod
      artifacts: true
  artifacts:
    paths:
      - summary.md
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
