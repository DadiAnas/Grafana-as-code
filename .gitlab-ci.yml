# =============================================================================
# GITLAB CI/CD — Grafana as Code
# =============================================================================
# This pipeline validates and deploys Grafana configuration via Terraform.
# Adapt the ENVIRONMENTS list and job definitions for your setup.
#
# Required CI/CD Variables (set in GitLab Settings > CI/CD > Variables):
#   VAULT_ADDR    — Vault server address
#   VAULT_TOKEN   — Vault authentication token (masked)
# =============================================================================

stages:
  - validate
  - security
  - plan
  - apply
  - cleanup

variables:
  TF_VERSION: "1.6.0"
  TF_ROOT: ${CI_PROJECT_DIR}
  # Vault configuration (set in GitLab CI/CD variables)
  # VAULT_ADDR: "https://vault.example.com"
  # VAULT_TOKEN: (masked variable)

# Default settings for all jobs
default:
  image:
    name: hashicorp/terraform:${TF_VERSION}
    entrypoint: [""]
  before_script:
    - cd ${TF_ROOT}
    - terraform --version
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${TF_ROOT}/.terraform/

# =============================================================================
# VALIDATE STAGE — Run on all branches and merge requests
# =============================================================================

fmt:check:
  stage: validate
  script:
    - terraform fmt -check -recursive -diff
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:
  stage: validate
  script:
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

lint:yaml:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install yamllint
  script:
    - yamllint -d relaxed config/
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# SECURITY STAGE — Static analysis
# =============================================================================

tfsec:
  stage: security
  image:
    name: aquasec/tfsec:latest
    entrypoint: [""]
  before_script: []
  script:
    - tfsec . --format json --out tfsec-report.json || true
    - tfsec . --format lovely
  artifacts:
    reports:
      security: tfsec-report.json
    paths:
      - tfsec-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# PLAN STAGE — Generate Terraform plan
# =============================================================================
# Duplicate or modify this job for each environment you add.
# =============================================================================

plan:myenv:
  stage: plan
  variables:
    ENVIRONMENT: myenv
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Generating plan for ${ENVIRONMENT}..."
      terraform plan \
        -var-file="environments/${ENVIRONMENT}.tfvars" \
        -out="${ENVIRONMENT}.tfplan" \
        -input=false
    - |
      echo "Saving plan summary..."
      terraform show -no-color "${ENVIRONMENT}.tfplan" > "${ENVIRONMENT}-plan.txt"
  artifacts:
    paths:
      - "${ENVIRONMENT}.tfplan"
      - "${ENVIRONMENT}-plan.txt"
    expire_in: 1 day
  environment:
    name: myenv
    action: prepare
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# APPLY STAGE — Deploy Terraform changes
# =============================================================================

apply:myenv:
  stage: apply
  variables:
    ENVIRONMENT: myenv
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Applying changes to ${ENVIRONMENT}..."
      terraform apply \
        -input=false \
        -auto-approve \
        "${ENVIRONMENT}.tfplan"
    - |
      echo "Deployment Summary:"
      terraform output -json > "${ENVIRONMENT}-outputs.json"
  artifacts:
    paths:
      - "${ENVIRONMENT}-outputs.json"
    expire_in: 1 week
  environment:
    name: myenv
    # url: https://grafana.example.com
    on_stop: destroy:myenv
  needs:
    - job: plan:myenv
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success

# =============================================================================
# CLEANUP STAGE — Destroy environments (manual trigger only)
# =============================================================================

destroy:myenv:
  stage: cleanup
  variables:
    ENVIRONMENT: myenv
  script:
    - |
      echo "Initializing Terraform for ${ENVIRONMENT}..."
      terraform init \
        -backend-config="backends/${ENVIRONMENT}.tfbackend"
    - |
      echo "Destroying ${ENVIRONMENT} environment..."
      terraform destroy \
        -var-file="environments/${ENVIRONMENT}.tfvars" \
        -auto-approve
  environment:
    name: myenv
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# =============================================================================
# SCHEDULED JOBS — Drift detection (optional)
# =============================================================================
# Enable this by creating a scheduled pipeline in GitLab.

drift:detection:
  stage: validate
  script:
    - |
      echo "Checking drift for myenv..."
      terraform init -backend-config="backends/myenv.tfbackend" -reconfigure
      terraform plan \
        -var-file="environments/myenv.tfvars" \
        -detailed-exitcode \
        -input=false \
        || if [ $? -eq 2 ]; then
          echo "WARNING: DRIFT DETECTED in myenv!"
          exit 1
        fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
