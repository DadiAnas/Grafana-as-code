# =============================================================================
# LOCAL DEVELOPMENT ENVIRONMENT
# =============================================================================
# Spins up Grafana + Vault + Keycloak for local testing.
#
# Usage:
#   make dev-up                    # Start all services
#   make dev-down                  # Stop all services
#   make dev-test                  # Run full test cycle
#
# Services:
#   Grafana:   http://localhost:3000  (admin/admin)
#   Vault:     http://localhost:8200  (token: root)
#   Keycloak:  http://localhost:8080  (admin/admin)
# =============================================================================

services:
  # ─── Grafana ────────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:11.5.1
    container_name: grafana-dev
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_LOG_LEVEL=info
      # API key auth
      - GF_AUTH_API_KEY_ENABLED=true
      # Allow embedding for testing
      - GF_SECURITY_ALLOW_EMBEDDING=true
    volumes:
      - grafana-data:/var/lib/grafana
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - grafana-network

  # ─── HashiCorp Vault ────────────────────────────────────────────────────
  vault:
    image: hashicorp/vault:1.18
    container_name: vault-dev
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - grafana-network

  # ─── Keycloak ───────────────────────────────────────────────────────────
  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    container_name: keycloak-dev
    command: start-dev
    ports:
      - "8080:8080"
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin
      - KC_HTTP_PORT=8080
      - KC_HEALTH_ENABLED=true
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200'"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - grafana-network

volumes:
  grafana-data:

networks:
  grafana-network:
    driver: bridge
